name: Run Skin Analysis & Recommendations

on:
  repository_dispatch:
    types: [run_analysis]

jobs:
  analyze_and_recommend:
    timeout-minutes: 20
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Notify Analysis Started
        if: always()
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          curl -H "Content-Type: application/json" \
          -d "{\"content\": \"üöÄ Analysis Started for **${{ github.event.client_payload.user_name }}** (ID: ${{ github.event.client_payload.user_id }}) (Env: ${{ github.event.client_payload.env }})\nRun: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\"}" \
          $DISCORD_WEBHOOK_URL

      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v5
        with:
          version: "latest"
          enable-cache: true
          cache-dependency-glob: "scripts/*.py"

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12" # Matches project requirement

      - name: Run Onboarding Script
        env:
          # Supabase DB
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }} # Fallback if script needs it

          # Supabase Storage (S3)
          SUPABASE_S3_ENDPOINT: ${{ secrets.SUPABASE_S3_ENDPOINT }}
          SUPABASE_S3_REGION: ${{ secrets.SUPABASE_S3_REGION }}
          SUPABASE_S3_ACCESS_KEY_ID: ${{ secrets.SUPABASE_S3_ACCESS_KEY_ID }}
          SUPABASE_S3_SECRET_ACCESS_KEY: ${{ secrets.SUPABASE_S3_SECRET_ACCESS_KEY }}
          # Buckets are determined by env flag (prod or dev)

          # AI Provider
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
          
          # Script Config
          PYTHONUNBUFFERED: "1"
          
          # Discord Notification Webhook
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}

        run: |
          echo "Starting analysis for User ID: ${{ github.event.client_payload.user_id }}"
          echo "Environment: ${{ github.event.client_payload.env }}"
          echo "${{ github.event.client_payload }}"
          
          # Install dependencies and run script
          # Note: 'uv run --script' handles dependency installation automatically from the inline script metadata
          uv run scripts/onboard_beta_user.py \
            --user-id "${{ github.event.client_payload.user_id }}" \
            --env "${{ github.event.client_payload.env }}" \
            --model "google-gla:gemini-2.5-pro" \
            --api-key "${{ secrets.GOOGLE_API_KEY }}" \
            --analysis-id "${{ github.event.client_payload.analysis_id }}"

      - name: Notify Analysis Success
        if: success()
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          curl -H "Content-Type: application/json" \
          -d "{\"content\": \"‚úÖ Analysis Succeeded for **${{ github.event.client_payload.user_name }}**!\nDashboard: https://app.lila.skin/${{ github.event.client_payload.user_id }}/dashboard\nRun: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\"}" \
          $DISCORD_WEBHOOK_URL

      - name: Notify Analysis Failure
        if: failure()
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          curl -H "Content-Type: application/json" \
          -d "{\"content\": \"‚ùå Analysis Failed for **${{ github.event.client_payload.user_name }}**.\nRun: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\"}" \
          $DISCORD_WEBHOOK_URL
